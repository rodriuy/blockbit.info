<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Kanban</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet.js CSS CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Firebase SDK CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Leaflet.js JS CDN -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Estilo para scrollbars (opcional, para consistencia visual) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .header-title { /* Placeholder for potential future use */ }
        .board-list { /* Placeholder for potential future use */ }
        .card-item { /* Placeholder for potential future use */ }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="h-screen flex flex-col">

        <!-- Encabezado -->
        <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
            <!-- Título del Tablero -->
            <h1 id="board-title" class="text-2xl font-bold header-title">Tablero Kanban</h1>
            <!-- Controles del Encabezado -->
            <div>
                <button id="filter-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <button id="calendar-toggle-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-calendar-alt"></i> Ver Calendario
                </button>
            </div>
        </header>

        <!-- Contenedor del Tablero Principal -->
        <main id="board-main-content" class="flex-grow p-4 overflow-x-auto">
            <!-- Aquí se mostrará el tablero o la vista de calendario -->
            <div id="board-view" class="h-full">
                <!-- Contenedor de las Listas (Kanban) -->
                <div id="lists-container" class="flex space-x-4 h-full">
                    <!-- Las listas de tareas (columnas) se insertarán aquí dinámicamente -->
                    <!-- Ejemplo de estructura de lista (para referencia, se generará con JS)
                    <div class="board-list bg-gray-200 p-3 rounded-lg shadow w-80 flex-shrink-0 flex flex-col">
                        <h2 class="text-lg font-semibold mb-3 text-gray-700">Nombre de la Lista</h2>
                        <div class="space-y-3 cards-container overflow-y-auto flex-grow">
                            <div class="card-item bg-white p-3 rounded shadow cursor-pointer hover:shadow-lg">
                                <p class="font-medium">Título de la Tarjeta 1</p>
                                <p class="text-sm text-gray-600 mt-1">Breve descripción o detalles...</p>
                            </div>
                        </div>
                        <button class="add-card-button mt-3 text-blue-500 hover:text-blue-700 py-2 rounded-md hover:bg-blue-100 w-full">
                            <i class="fas fa-plus"></i> Añadir tarjeta
                        </button>
                    </div>
                    -->
                    <!-- Botón para añadir nueva lista -->
                    <div class="flex-shrink-0">
                         <button id="add-list-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded h-12">
                            <i class="fas fa-plus"></i> Añadir otra lista
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista de Calendario (inicialmente oculta) -->
            <div id="calendar-view" class="hidden h-full">
                <!-- Controles del Calendario (mes anterior/siguiente, etc.) -->
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-chevron-left"></i> Mes Anterior
                    </button>
                    <h2 id="current-month-year" class="text-xl font-semibold">Mes Año</h2>
                    <button id="next-month-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Mes Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <!-- Cuadrícula del Calendario -->
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 bg-white p-2 rounded shadow">
                    <!-- Días de la semana -->
                    <!-- Las celdas del calendario se generarán aquí -->
                </div>
            </div>
        </main>

        <!-- Modal para Detalles de Tarjeta (inicialmente oculto) -->
        <div id="card-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
                <!-- Encabezado del Modal -->
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 id="modal-card-title" class="text-2xl font-semibold text-gray-800">Detalles de la Tarjeta</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <!-- Cuerpo del Modal (con scroll si es necesario) -->
                <div class="overflow-y-auto pr-2 flex-grow">
                    <!-- Sección de Descripción -->
                    <div class="mb-4">
                        <label for="modal-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción (Markdown)</label>
                        <textarea id="modal-description" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Añadir una descripción más detallada... Compatible con **bold**, *italic*, y listas con '- '."></textarea>
                        <div class="mt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vista Previa:</label>
                            <div id="modal-description-preview" class="p-2 border rounded bg-gray-50 min-h-[50px] prose max-w-none"></div>
                        </div>
                    </div>

                    <!-- Otras secciones (Miembros, Etiquetas, Checklist, etc.) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Miembros -->
                        <div>
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Miembros</h4>
                            <div id="modal-members-list">
                                <!-- Los miembros asignados se mostrarán aquí -->
                                <p class="text-sm text-gray-500">No hay miembros asignados.</p>
                            </div>
                            <button id="manage-members-button" class="mt-2 text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-users"></i> Gestionar Miembros</button>
                        </div>
                        <!-- Etiquetas -->
                        <div>
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Etiquetas</h4>
                            <div id="modal-labels-list">
                                <!-- Las etiquetas asignadas se mostrarán aquí -->
                                <p class="text-sm text-gray-500">No hay etiquetas.</p>
                            </div>
                            <button id="manage-labels-button" class="mt-2 text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-tags"></i> Gestionar Etiquetas</button>
                        </div>
                    </div>

                    <!-- Fecha de Vencimiento -->
                    <div class="mb-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Fecha de Vencimiento</h4>
                        <div id="modal-due-date-display">
                            <p class="text-sm text-gray-500">No establecida.</p>
                        </div>
                        <button id="edit-due-date-button" class="mt-1 text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-calendar-day"></i> Editar Fecha</button>
                        <input type="date" id="modal-due-date-input" class="hidden mt-1 p-2 border border-gray-300 rounded-md">
                    </div>

                    <!-- Checklist -->
                    <div id="modal-checklists-container" class="mb-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Checklist(s)</h4>
                        <!-- Los checklists se agregarán aquí -->
                        <button id="add-checklist-button" class="mt-2 text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-plus-square"></i> Añadir Checklist</button>
                    </div>

                    <!-- Ubicación -->
                     <div class="mb-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Ubicación</h4>
                        <div id="modal-location-display">
                            <p class="text-sm text-gray-500">No hay ubicación establecida.</p>
                            <!-- Contenedor para el mapa estático de Leaflet -->
                            <div id="modal-static-map-preview" class="h-40 w-full bg-gray-200 rounded mt-1"></div>
                        </div>
                        <button id="add-edit-location-button" class="mt-1 text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-map-marker-alt"></i> Añadir/Editar Ubicación</button>
                    </div>

                    <!-- Archivos Adjuntos -->
                    <div class="mb-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Archivos Adjuntos</h4>
                        <div id="attachments-display-area" class="space-y-2">
                            <!-- Los archivos adjuntos se listarán aquí -->
                            <p class="text-sm text-gray-500">No hay archivos adjuntos.</p>
                        </div>
                        <button id="add-attachment-button" class="mt-3 text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-paperclip"></i> Adjuntar archivo (URL)
                        </button>
                    </div>

                    <!-- Actividad Reciente -->
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Actividad</h4>
                        <div class="mb-2">
                            <input type="text" id="new-comment-input" placeholder="Escribe un comentario..." class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
                            <button id="submit-comment-button" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded text-sm">
                                Comentar
                            </button>
                        </div>
                        <div id="modal-activity-log" class="space-y-2 max-h-48 overflow-y-auto bg-gray-50 p-2 rounded border">
                            <!-- Las entradas de actividad se mostrarán aquí -->
                            <p class="text-sm text-gray-400 italic">No hay actividad reciente.</p>
                        </div>
                    </div>

                </div>
                <!-- Pie del Modal -->
                <div class="mt-6 flex justify-end space-x-3 border-t pt-4">
                    <button id="save-card-changes-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <button id="archive-card-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-archive"></i> Archivar Tarjeta
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Selector de Ubicación con Leaflet (inicialmente oculto) -->
        <div id="location-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-[60]">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full">
                <h3 class="text-xl font-semibold mb-4">Seleccionar Ubicación</h3>
                <input type="text" id="location-search-input" placeholder="Buscar dirección..." class="w-full p-2 border border-gray-300 rounded-md mb-2">
                <div id="leaflet-map-container" style="height: 300px;" class="rounded-md"></div>
                <p id="selected-location-text" class="mt-2 text-sm text-gray-600">Ubicación seleccionada: Ninguna</p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="confirm-location-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Confirmar</button>
                    <button id="cancel-location-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancelar</button>
                </div>
            </div>
        </div>


    </div> <!-- Fin de app-container -->

    <script>
        // El código JavaScript para la lógica de la aplicación irá aquí.
        // Por ejemplo, inicialización de Firebase, manipulación del DOM, etc.
        document.addEventListener('DOMContentLoaded', () => {
            // Lógica inicial de la aplicación como cerrar modales, etc.
            const cardDetailModal = document.getElementById('card-detail-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            if (closeModalButton) {
                closeModalButton.onclick = () => cardDetailModal.classList.add('hidden'); // Simplified close
            }

            const locationPickerModal = document.getElementById('location-picker-modal');
            const cancelLocationButton = document.getElementById('cancel-location-button');
            if(cancelLocationButton) {
                cancelLocationButton.onclick = () => locationPickerModal.classList.add('hidden');
            }

            // Firebase configuration placeholder
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Global Variables
            let currentBoardData = null;
            let activeCardContext = {
                cardId: null,
                listId: null,
                originalTitle: '',
                tempTitle: '',
                originalDescription: '',
                tempDescription: '',
                originalMembers: [],
                tempMembers: [],
                originalLabels: [],
                tempLabels: [],
                originalDueDate: null,
                tempDueDate: null,
                originalChecklists: [],
                tempChecklists: [],
                originalLocation: null,
                tempLocation: null,
                originalAttachments: [],
                tempAttachments: [],
                originalActivity: [],
                tempActivity: [],
                // Add startDate here for the next step
                originalStartDate: null,
                tempStartDate: null,
            };
            // IMPORTANT: Replace 'YOUR_APP_ID_OR_PROJECT_ID' with your actual Firebase App ID or Project ID
            // This path structure is just an example. Adjust to your needs.
            const boardDocRef = db.collection('artifacts').doc('YOUR_APP_ID_OR_PROJECT_ID_REPLACE_ME').collection('public').doc('data').collection('boards').doc('main_board');


            // Basic Anonymous Sign-in
            auth.signInAnonymously()
                .then(() => {
                    console.log("User signed in anonymously.");
                })
                .catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });

            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log("User signed in anonymously, UID:", user.uid);
                    initializeAppLogic();
                } else {
                    console.log("User signed out.");
                    // Potentially disable UI or show a message
                }
            });

            async function initializeAppLogic() {
                console.log("App logic initialization started.");
                try {
                    const docSnap = await boardDocRef.get();
                    if (!docSnap.exists()) {
                        console.log("Board document does not exist. Setting up initial data...");
                        await setupInitialData();
                    } else {
                        console.log("Board document found.");
                        // currentBoardData = docSnap.data(); // Initial load before snapshot listener
                        // console.log("Initial board data loaded:", currentBoardData);
                    }
                } catch (error) {
                    console.error("Error checking/fetching board document:", error);
                    // Optionally, still try to setup initial data or handle error appropriately
                    // For now, we'll let the onSnapshot handle further attempts or errors.
                }

                // Setup the real-time listener
                boardDocRef.onSnapshot(docSnap => {
                    if (docSnap.exists()) {
                        currentBoardData = docSnap.data();
                        console.log("Board data received/updated via onSnapshot:", currentBoardData);
                        // renderListsAndCards(); // Future function: To render the board dynamically
                    } else {
                        // This case should ideally be handled by the initial get() and setupInitialData()
                        // but as a fallback or if the doc is deleted after initial load:
                        console.log("Board document does not exist (detected by onSnapshot). Consider re-initializing or error handling.");
                        // If it's critical to always have data, you might call setupInitialData() again,
                        // but be cautious of loops if setupInitialData() itself fails.
                    }
                }, error => {
                    console.error("Error listening to board document with onSnapshot:", error);
                });
            }

            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function addNewCardToList(listId, cardTitle) {
                const newCard = {
                    id: generateUniqueId(),
                    title: cardTitle || "Nueva Tarjeta",
                    description: "",
                    members: [], // Array of user IDs or objects
                    labels: [], // Array of label IDs or objects
                    dueDate: null, // Timestamp or ISO string
                    checklists: [], // Array of checklist objects
                    location: null, // { lat: number, lng: number, address: string }
                    attachments: [], // Array of attachment objects { url: string, name: string, type: string }
                    activity: [], // Array of activity log entries { user: string, action: string, timestamp: date }
                    startDate: null, // Timestamp or ISO string for card start/creation visible on card
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Auto-timestamp
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(), // Auto-timestamp
                };
                console.log("New card created (not saved yet):", newCard);
                return newCard;
                // In a real scenario, this would then update Firestore:
                // const listRef = db.collection('lists').doc(listId);
                // listRef.update({
                //   cards: firebase.firestore.FieldValue.arrayUnion(newCard)
                // });
            }

            // Example of how it might be called (e.g., from a UI button for a specific list)
            // addNewCardToList('list1_id', 'Mi Primera Tarjeta');


            async function setupInitialData() {
                console.log("Setting up initial board data in Firestore...");

                const user_you_id = generateUniqueId();
                const user_belen_id = generateUniqueId();
                const user_micaela_id = generateUniqueId();

                const initialTeamMembers = [
                    { id: user_you_id, name: "Tú", avatar: "https://placehold.co/40x40/007bff/ffffff?text=T" },
                    { id: user_belen_id, name: "Belén", avatar: "https://placehold.co/40x40/28a745/ffffff?text=B" },
                    { id: user_micaela_id, name: "Micaela", avatar: "https://placehold.co/40x40/ffc107/000000?text=M" }
                ];

                const label_tech_id = generateUniqueId();
                const label_research_id = generateUniqueId();
                const label_design_id = generateUniqueId();
                const label_urgent_id = generateUniqueId();
                const label_management_id = generateUniqueId();
                const label_marketing_id = generateUniqueId();

                const initialAvailableLabels = [
                    { id: label_tech_id, name: "Tech", color: "bg-blue-500" },
                    { id: label_research_id, name: "Investigación", color: "bg-purple-500" },
                    { id: label_design_id, name: "Diseño", color: "bg-pink-500" },
                    { id: label_urgent_id, name: "Urgente", color: "bg-red-500" },
                    { id: label_management_id, name: "Gestión", color: "bg-yellow-500" },
                    { id: label_marketing_id, name: "Marketing", color: "bg-green-500" }
                ];

                const now = new Date();
                const todayISO = now.toISOString();
                const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
                const tomorrowISO = tomorrow.toISOString();
                const nextWeek = new Date(now); nextWeek.setDate(now.getDate() + 7);
                const nextWeekISO = nextWeek.toISOString();
                const nextMonth = new Date(now); nextMonth.setMonth(now.getMonth() + 1);
                const nextMonthISO = nextMonth.toISOString();


                const initialLists = [
                    {
                        id: generateUniqueId(),
                        title: "JUNIO: Planificación y Diseño",
                        cards: [
                            {
                                id: generateUniqueId(),
                                title: "Definición del MVP",
                                description: "Definir alcance y características clave para la primera versión. Sesión de brainstorming con el equipo.",
                                dueDate: "2025-06-22T23:59:59Z",
                                startDate: "2025-06-10T09:00:00Z",
                                members: [user_you_id, user_belen_id],
                                labels: [label_management_id, label_research_id],
                                coverImage: "https://placehold.co/600x400/1e3a8a/93c5fd?text=Planificaci%C3%B3n",
                                checklists: [
                                    { id: generateUniqueId(), title: "Tareas Clave", items: [
                                        { id: generateUniqueId(), text: "Investigar competidores", completed: true },
                                        { id: generateUniqueId(), text: "Definir User Personas", completed: false },
                                        { id: generateUniqueId(), text: "Esbozar primeros wireframes", completed: false }
                                    ]}
                                ],
                                location: null,
                                attachments: [ { name: "Requerimientos MVP.docx", url: "#placeholder_mvp_doc" } ],
                                activity: [
                                    { user: user_you_id, text: "Tarjeta creada.", timestamp: "2025-06-10T09:00:00Z" },
                                    { user: user_belen_id, text: "Revisar la sección de user personas.", timestamp: "2025-06-11T14:30:00Z" }
                                ],
                                createdAt: "2025-06-10T09:00:00Z",
                                updatedAt: "2025-06-11T14:30:00Z"
                            },
                            {
                                id: generateUniqueId(),
                                title: "Diseño UI/UX - Mockups Iniciales",
                                description: "Crear los primeros mockups para las vistas principales de la aplicación.",
                                dueDate: "2025-06-30T23:59:59Z",
                                startDate: "2025-06-15T09:00:00Z",
                                members: [user_micaela_id],
                                labels: [label_design_id],
                                coverImage: null,
                                checklists: [],
                                location: null,
                                attachments: [
                                    { name: "Guía de Estilo V1.pdf", url: "#placeholder_styleguide" },
                                    { name: "Inspiración Visual.png", url: "#placeholder_inspiration_img" }
                                ],
                                activity: [ { user: user_micaela_id, text: "Iniciando mockups.", timestamp: "2025-06-15T10:00:00Z" } ],
                                createdAt: "2025-06-15T09:00:00Z",
                                updatedAt: "2025-06-15T10:00:00Z"
                            }
                        ]
                    },
                    {
                        id: generateUniqueId(),
                        title: "JULIO: Construcción",
                        cards: [
                            {
                                id: generateUniqueId(),
                                title: "Desarrollo del Core Frontend",
                                description: "Implementar la estructura base y componentes principales.",
                                dueDate: "2025-07-25T23:59:59Z",
                                startDate: "2025-07-01T09:00:00Z",
                                members: [user_you_id, user_belen_id],
                                labels: [label_tech_id, label_urgent_id],
                                coverImage: "https://placehold.co/600x400/d97706/fde68a?text=Construcci%C3%B3n",
                                checklists: [],
                                location: null,
                                attachments: [],
                                activity: [ { user: user_you_id, text: "Iniciando desarrollo.", timestamp: "2025-07-01T09:30:00Z" } ],
                                createdAt: "2025-07-01T09:00:00Z",
                                updatedAt: "2025-07-01T09:30:00Z"
                            },
                            {
                                id: generateUniqueId(),
                                title: "Configuración de Base de Datos",
                                description: "Definir esquema y configurar Firebase Firestore.",
                                dueDate: "2025-07-10T23:59:59Z",
                                startDate: "2025-07-02T09:00:00Z",
                                members: [user_belen_id],
                                labels: [label_tech_id],
                                coverImage: null,
                                checklists: [],
                                location: null,
                                attachments: [{ name: "Esquema Firestore.json", url:"#placeholder_schema"}],
                                activity: [],
                                createdAt: "2025-07-02T09:00:00Z",
                                updatedAt: "2025-07-02T09:00:00Z"
                            }
                        ]
                    },
                    {
                        id: generateUniqueId(),
                        title: "AGOSTO: Lanzamiento",
                        cards: [
                            {
                                id: generateUniqueId(),
                                title: "Retirar tarjetas de la imprenta",
                                description: "Recoger las tarjetas de presentación y material promocional.",
                                dueDate: nextWeekISO, // Example dynamic date
                                startDate: tomorrowISO,
                                members: [user_micaela_id],
                                labels: [label_marketing_id, label_management_id],
                                coverImage: null,
                                checklists: [],
                                location: { lat: -30.8933, lng: -55.5508, text: "Plaza Artigas, Artigas, Departamento de Artigas, Uruguay" }, // Placeholder, actual address might vary
                                attachments: [],
                                activity: [ { user: user_micaela_id, text: "Confirmar horario de retiro.", timestamp: todayISO}],
                                createdAt: todayISO,
                                updatedAt: todayISO
                            }
                        ]
                    },
                     {
                        id: generateUniqueId(),
                        title: "SEPTIEMBRE: Crecimiento",
                        cards: []
                    },
                    {
                        id: generateUniqueId(),
                        title: "OCTUBRE: Preparación Final",
                        cards: []
                    }
                ];

                const newBoardData = {
                    title: "Tablero Kanban Principal", // Added a board title
                    teamMembers: initialTeamMembers,
                    availableLabels: initialAvailableLabels,
                    lists: initialLists,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                };

                try {
                    await boardDocRef.set(newBoardData);
                    console.log("Initial board data successfully written to Firestore.");
                    currentBoardData = newBoardData; // Set currentBoardData after successful write
                } catch (error) {
                    console.error("Error writing initial board data to Firestore:", error);
                }
            }

            function openCardModal(cardData, currentListId) {
                if (!cardData) {
                    console.error("openCardModal: cardData is undefined.");
                    return;
                }
                activeCardContext = {
                    cardId: cardData.id,
                    listId: currentListId, // The ID of the list this card belongs to

                    originalTitle: cardData.title,
                    tempTitle: cardData.title,
                    originalDescription: cardData.description || '',
                    tempDescription: cardData.description || '',

                    // For arrays and objects, ensure deep copies for temp versions
                    originalMembers: JSON.parse(JSON.stringify(cardData.members || [])),
                    tempMembers: JSON.parse(JSON.stringify(cardData.members || [])),
                    originalLabels: JSON.parse(JSON.stringify(cardData.labels || [])),
                    tempLabels: JSON.parse(JSON.stringify(cardData.labels || [])),

                    originalDueDate: cardData.dueDate || null,
                    tempDueDate: cardData.dueDate || null,

                    originalChecklists: JSON.parse(JSON.stringify(cardData.checklists || [])),
                    tempChecklists: JSON.parse(JSON.stringify(cardData.checklists || [])),

                    originalLocation: cardData.location ? JSON.parse(JSON.stringify(cardData.location)) : null,
                    tempLocation: cardData.location ? JSON.parse(JSON.stringify(cardData.location)) : null,

                    originalAttachments: JSON.parse(JSON.stringify(cardData.attachments || [])),
                    tempAttachments: JSON.parse(JSON.stringify(cardData.attachments || [])),

                    originalActivity: JSON.parse(JSON.stringify(cardData.activity || [])), // Activity log might not be directly editable this way
                    tempActivity: JSON.parse(JSON.stringify(cardData.activity || [])), // but good to have for display

                    originalStartDate: cardData.startDate || null,
                    tempStartDate: cardData.startDate || null,
                };

                // Populate modal static title (if it's separate from an input)
                const modalCardTitleDisplay = document.getElementById('modal-card-title');
                if (modalCardTitleDisplay) modalCardTitleDisplay.textContent = cardData.title; // This is the h3, not an input

                // Populate modal input fields
                // Assuming 'modal-card-title' is an input for editing title, if not, one needs to be added or handled differently.
                // For now, let's assume there's an input for title, e.g., <input id="modal-title-input">
                const titleInput = document.getElementById('modal-title-input'); // Placeholder ID, adjust to actual
                if (titleInput) titleInput.value = cardData.title;

                const descriptionInput = document.getElementById('modal-description');
                if (descriptionInput) {
                    descriptionInput.value = activeCardContext.tempDescription;
                    updateDescriptionPreview(activeCardContext.tempDescription);
                }

                // Populate Attachments
                renderAttachmentsList(activeCardContext.tempAttachments);

                // Populate Activity Log
                renderActivityLog(activeCardContext.tempActivity);


                // Further population for members, labels, due date, checklists, location would go here.
                // For example, for due date:
                const dueDateInput = document.getElementById('modal-due-date-input');
                if (dueDateInput && activeCardContext.tempDueDate) {
                    // Assuming dueDate is stored as ISO string (YYYY-MM-DD) or can be converted
                    dueDateInput.value = activeCardContext.tempDueDate.split('T')[0];
                }


                console.log("activeCardContext populated:", activeCardContext);
                cardDetailModal.classList.remove('hidden');
            }

            function saveCardChanges() {
                // Construct updatedCardData from modal fields and activeCardContext.temp... versions
                const updatedCardData = {
                    id: activeCardContext.cardId, // Keep the original ID
                    title: document.getElementById('modal-title-input') ? document.getElementById('modal-title-input').value : activeCardContext.tempTitle, // Assuming an input for title
                    description: document.getElementById('modal-description').value,
                    members: JSON.parse(JSON.stringify(activeCardContext.tempMembers)), // Deep copy
                    labels: JSON.parse(JSON.stringify(activeCardContext.tempLabels)),   // Deep copy
                    dueDate: activeCardContext.tempDueDate,
                    checklists: JSON.parse(JSON.stringify(activeCardContext.tempChecklists)), // Deep copy
                    location: activeCardContext.tempLocation ? JSON.parse(JSON.stringify(activeCardContext.tempLocation)) : null, // Deep copy
                    attachments: JSON.parse(JSON.stringify(activeCardContext.tempAttachments)), // Deep copy
                    // Activity is usually append-only and handled by specific actions, not direct edit here.
                    // startDate might be editable, similar to dueDate
                    startDate: activeCardContext.tempStartDate,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(), // Update timestamp
                };

                console.log("Saving card changes (not implemented yet):", updatedCardData);
                // In a real scenario, this would find the card in currentBoardData.lists[...].cards[...]
                // and update it, then save currentBoardData to Firestore.
                // Or, update Firestore directly:
                // db.collection('lists').doc(activeCardContext.listId).collection('cards').doc(activeCardContext.cardId).update(updatedCardData);

                // Close modal after saving (conceptual)
                // cardDetailModal.classList.add('hidden');
            }

            // const saveChangesButton = document.getElementById('save-card-changes-button');
            // if (saveChangesButton) {
            //     saveChangesButton.onclick = saveCardChanges;
            // }

            function formatTimestamp(isoString) {
                if (!isoString) return 'Fecha desconocida';
                try {
                    const d = new Date(isoString);
                    // Check if date is valid
                    if (isNaN(d.getTime())) {
                        return 'Fecha inválida';
                    }
                    const datePart = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timePart = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    return `${datePart} ${timePart}`;
                } catch (e) {
                    console.error("Error formatting timestamp:", e, "Input:", isoString);
                    return 'Error de fecha';
                }
            }


            function renderActivityLog(activityArray) {
                const logContainer = document.getElementById('modal-activity-log');
                if (!logContainer) return;

                logContainer.innerHTML = ''; // Clear existing entries

                if (!activityArray || activityArray.length === 0) {
                    logContainer.innerHTML = '<p class="text-sm text-gray-400 italic">No hay actividad reciente.</p>';
                    return;
                }

                // Iterate in reverse for newest first, or sort/reverse a copy if original order matters elsewhere
                [...activityArray].reverse().forEach(activity => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'text-xs p-1.5 rounded bg-white shadow-sm';

                    const userStrong = document.createElement('strong');
                    userStrong.textContent = activity.user || "Usuario desconocido";
                    userStrong.className = 'text-gray-800';

                    const textSpan = document.createElement('span');
                    textSpan.textContent = `: ${activity.text || "Acción sin texto."}`;
                    textSpan.className = 'text-gray-600';

                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = formatTimestamp(activity.timestamp);
                    timeSpan.className = 'block text-gray-400 text-right text-[10px] mt-0.5';

                    entryDiv.appendChild(userStrong);
                    entryDiv.appendChild(textSpan);
                    entryDiv.appendChild(timeSpan);
                    logContainer.appendChild(entryDiv);
                });
            }

            const submitCommentButton = document.getElementById('submit-comment-button');
            const newCommentInput = document.getElementById('new-comment-input');

            if (submitCommentButton && newCommentInput) {
                submitCommentButton.onclick = () => {
                    const commentText = newCommentInput.value.trim();
                    if (commentText) {
                        const newActivity = {
                            user: "Tú", // Assuming 'Tú' is the current user. This should be dynamic in a real app.
                            text: commentText,
                            timestamp: new Date().toISOString()
                        };
                        if (!activeCardContext.tempActivity) {
                            activeCardContext.tempActivity = [];
                        }
                        activeCardContext.tempActivity.unshift(newActivity); // Add to the beginning for chronological display
                        renderActivityLog(activeCardContext.tempActivity);
                        newCommentInput.value = ''; // Clear input
                    }
                };
                // Optional: Allow submitting comment with Enter key
                newCommentInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        submitCommentButton.click();
                    }
                });
            }


            function renderAttachmentsList(attachmentsArray) {
                const displayArea = document.getElementById('attachments-display-area');
                if (!displayArea) return;

                displayArea.innerHTML = ''; // Clear existing content

                if (!attachmentsArray || attachmentsArray.length === 0) {
                    displayArea.innerHTML = '<p class="text-sm text-gray-500">No hay archivos adjuntos.</p>';
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'list-disc pl-5 space-y-1';

                attachmentsArray.forEach((attachment, index) => {
                    const li = document.createElement('li');
                    li.className = 'text-sm flex justify-between items-center';

                    const link = document.createElement('a');
                    link.href = attachment.url;
                    link.textContent = attachment.name;
                    link.target = '_blank';
                    link.className = 'text-blue-600 hover:underline hover:text-blue-800 break-all';
                    link.title = attachment.url;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.className = 'text-red-500 hover:text-red-700 ml-3 p-1 rounded hover:bg-red-100';
                    deleteBtn.dataset.attachmentIndex = index; // Use index to identify for deletion
                    deleteBtn.title = 'Eliminar adjunto';

                    deleteBtn.onclick = () => {
                        activeCardContext.tempAttachments.splice(index, 1); // Remove from temp context
                        renderAttachmentsList(activeCardContext.tempAttachments); // Re-render
                    };

                    li.appendChild(link);
                    li.appendChild(deleteBtn);
                    ul.appendChild(li);
                });
                displayArea.appendChild(ul);
            }

            const addAttachmentButton = document.getElementById('add-attachment-button');
            if (addAttachmentButton) {
                addAttachmentButton.onclick = () => {
                    const fileName = prompt("Introduce el nombre del archivo:");
                    if (fileName && fileName.trim() !== "") {
                        const fileURL = prompt("Introduce la URL del archivo (ej: https://example.com/document.pdf):");
                        if (fileURL && fileURL.trim() !== "") {
                            // Basic URL validation (starts with http/https)
                            if (!fileURL.toLowerCase().startsWith('http://') && !fileURL.toLowerCase().startsWith('https://')) {
                                alert("URL inválida. Debe comenzar con http:// o https://");
                                return;
                            }
                            const newAttachment = { name: fileName.trim(), url: fileURL.trim() };
                            if (!activeCardContext.tempAttachments) {
                                activeCardContext.tempAttachments = [];
                            }
                            activeCardContext.tempAttachments.push(newAttachment);
                            renderAttachmentsList(activeCardContext.tempAttachments);
                        } else if (fileURL !== null) { // User didn't cancel but entered empty string
                            alert("La URL del archivo no puede estar vacía.");
                        }
                    } else if (fileName !== null) { // User didn't cancel but entered empty string
                        alert("El nombre del archivo no puede estar vacío.");
                    }
                };
            }

            // Markdown Parsing Function
            function parseMarkdown(markdownText) {
                if (typeof markdownText !== 'string') {
                    return '';
                }
                let html = markdownText;

                // Bold: **text**
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                // Italic: *text* or _text_
                // Ensure that we don't mess up URLs or other uses of underscores.
                // This regex tries to match *word* or _word_ not part of a larger word.
                html = html.replace(/(?:^|\s)\*(.*?)\*(?:$|\s)/g, ' <em>$1</em> '); // Handles *italic* with spaces around
                html = html.replace(/(?:^|\s)_(.*?)_(?:$|\s)/g, ' <em>$1</em> '); // Handles _italic_ with spaces around
                // Simpler regex if the above is too restrictive:
                // html = html.replace(/(\*|_)(.*?)\1/g, '<em>$2</em>');


                // Unordered lists: - item
                // Process line by line to handle <ul> wrapping correctly
                const lines = html.split('\n');
                let inList = false;
                const processedLines = lines.map(line => {
                    const listItemMatch = line.match(/^\s*-\s+(.*)/);
                    if (listItemMatch) {
                        if (!inList) {
                            inList = true;
                            return '<ul><li>' + listItemMatch[1] + '</li>';
                        }
                        return '<li>' + listItemMatch[1] + '</li>';
                    } else {
                        if (inList) {
                            inList = false;
                            return '</ul>' + line; // Close list before non-list item
                        }
                        return line;
                    }
                });

                html = processedLines.join('\n');
                if (inList) { // Close any list that's still open at the end
                    html += '</ul>';
                }

                // Paragraphs (simple version: wrap non-list-processed text blocks in <p>)
                // This is a very basic approach and might need refinement.
                // Avoid wrapping existing HTML tags like <ul> or <li>
                // html = html.split('\n\n').map(paragraph => {
                //    if (!paragraph.startsWith('<ul') && !paragraph.startsWith('<li')) {
                //        return `<p>${paragraph}</p>`;
                //    }
                //    return paragraph;
                // }).join('');
                // For now, let's rely on Tailwind's prose class or browser default for paragraph spacing.
                // Replacing double newlines with <br><br> for paragraph breaks if not using <p> tags
                html = html.replace(/\n\n/g, '<br><br>');
                html = html.replace(/\n/g, '<br>'); // Convert single newlines to <br> for simplicity

                return html.trim(); // Trim leading/trailing whitespace
            }

            function updateDescriptionPreview(markdownText) {
                const previewElement = document.getElementById('modal-description-preview');
                if (previewElement) {
                    previewElement.innerHTML = parseMarkdown(markdownText);
                }
            }

            // Event listener for live preview of description
            const descriptionTextarea = document.getElementById('modal-description');
            if (descriptionTextarea) {
                descriptionTextarea.addEventListener('input', (event) => {
                    updateDescriptionPreview(event.target.value);
                    // Also update tempDescription in activeCardContext if you want live updates to context
                    if (activeCardContext) { // Make sure context is available
                         activeCardContext.tempDescription = event.target.value;
                    }
                });
            }


            // Example: Simulate opening a card to test openCardModal
            // This would typically be triggered by a click on a rendered card.
            // setTimeout(() => {
            //     const dummyCard = {
            //         id: 'card123',
            //         title: 'Test Card from JS',
            //         description: 'This is a test description.',
            //         members: [{id: 'user1', name: 'Alice'}],
            //         labels: [{id: 'label1', name: 'Urgent', color: 'red'}],
            //         dueDate: new Date().toISOString(),
            //         checklists: [{id: 'cl1', title: 'Tasks', items: [{id: 'item1', text: 'Do this', completed: false}]}],
            //         location: { lat: 12.34, lng: 56.78, address: '123 Main St' },
            //         attachments: [{name: 'file.pdf', url: '/path/to/file.pdf'}],
            //         activity: [{user: 'user1', action: 'created card', timestamp: new Date()}],
            //         startDate: new Date(Date.now() - 86400000).toISOString() // Yesterday
            //     };
            //     openCardModal(dummyCard, 'listABC');
            // }, 2000); // Delay to ensure DOM is ready and user can see the modal pop up

        });
    </script>
</body>
</html>
