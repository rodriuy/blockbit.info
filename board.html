<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Blockbit</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet.js CSS CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Firebase SDK CDN (v8 compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Leaflet.js JS CDN -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .board-list { min-width: 280px; max-width: 320px; }
        .modal-body-scroll { max-height: calc(90vh - 160px); /* Adjusted for typical header/footer */ }
        .prose img { margin-top: 0; margin-bottom: 0; } /* Tailwind prose class compatibility */
        .dragging { opacity: 0.5; transform: rotate(2deg); }
        .drag-over-list { background-color: #e0f2fe !important; /* light sky blue */ border: 2px dashed #38bdf8;}
        .active-view-btn { background-color: #1d4ed8 !important; /* Darker blue for active view */ }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #edf2f7; border-radius: 3px; }

    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="h-screen flex flex-col">

        <!-- Encabezado -->
        <header class="bg-blue-700 text-white p-4 shadow-lg flex justify-between items-center print:hidden">
            <h1 class="text-2xl font-bold">Tablero Blockbit</h1>
            <div class="space-x-2">
                <button id="board-view-btn" class="bg-blue-800 text-white font-semibold py-2 px-3 rounded-md text-sm view-toggle-btn active-view-btn transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95" data-view="board-view"><i class="fas fa-th-large mr-2"></i>Tablero</button>
                <button id="calendar-view-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm view-toggle-btn transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95" data-view="calendar-view"><i class="fas fa-calendar-alt mr-2"></i>Calendario</button>
                <button id="timeline-view-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm view-toggle-btn transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95" data-view="timeline-view"><i class="fas fa-chart-gantt mr-2"></i>Cronograma</button>
                <button id="dashboard-view-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm view-toggle-btn transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95" data-view="dashboard-view"><i class="fas fa-tachometer-alt mr-2"></i>Panel</button>
                <button id="filter-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95"><i class="fas fa-filter mr-2"></i>Filtrar</button>
            </div>
        </header>

        <!-- Área de Contenido Principal -->
        <main id="main-content-area" class="flex-grow p-6 overflow-hidden">
            <!-- Vista de Tablero (Kanban) -->
            <div id="board-view" class="h-full overflow-x-auto">
                <div id="lists-container" class="flex space-x-6 h-full pb-4">
                    <!-- Las listas se insertarán aquí -->
                    <div class="flex-shrink-0">
                        <button id="add-list-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md shadow w-72 h-12 flex items-center justify-center transform transition-all duration-150 ease-in-out hover:scale-105 active:scale-95">
                            <i class="fas fa-plus mr-2"></i> Añadir otra lista
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista de Calendario (Oculta por defecto) -->
            <div id="calendar-view" class="hidden h-full bg-white p-4 rounded-lg shadow transition-opacity duration-300 ease-in-out">
                <h2 class="text-xl font-semibold mb-3">Vista de Calendario</h2>
                 <p>El calendario se mostrará aquí.</p>
            </div>

            <!-- Vista de Cronograma (Oculta por defecto) -->
            <div id="timeline-view" class="hidden h-full bg-white p-4 rounded-lg shadow transition-opacity duration-300 ease-in-out">
                <h2 class="text-xl font-semibold mb-3">Vista de Cronograma (Gantt)</h2>
                <p>El cronograma se mostrará aquí.</p>
            </div>

            <!-- Vista de Panel (Oculta por defecto) -->
            <div id="dashboard-view" class="hidden h-full bg-white p-4 rounded-lg shadow transition-opacity duration-300 ease-in-out">
                <h2 class="text-xl font-semibold mb-3">Panel de Métricas</h2>
                <p>Las métricas y gráficos se mostrarán aquí.</p>
            </div>
        </main>

        <!-- Modal para Detalles de Tarjeta -->
        <!-- Modal para Detalles de Tarjeta -->
        <div id="card-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-50 print:hidden transition-opacity duration-300 ease-in-out">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-3xl w-full flex flex-col modal-body-scroll transform transition-all duration-300 ease-in-out">
                <!-- Encabezado del Modal -->
                <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4 bg-blue-600 -m-6 p-6 rounded-t-xl"> {/* Modal Header with Blue Background */}
                    <div class="flex items-center w-full">
                         <i class="fas fa-credit-card text-xl text-blue-100 mr-3"></i>
                        <input type="text" id="modal-title-input" class="text-xl font-semibold text-white bg-transparent border-b-2 border-blue-400 focus:border-blue-200 outline-none w-full transition-colors duration-150 ease-in-out" placeholder="Título de la Tarjeta">
                    </div>
                    <button id="close-modal-button" class="text-blue-100 hover:text-white hover:bg-blue-500 rounded-full p-1 transition-all duration-150 ease-in-out transform hover:scale-110">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>

                {/* Cuerpo del Modal - Adjusted top margin due to header background change */}
                <div class="overflow-y-auto pr-3 pt-6 flex-grow custom-scrollbar">
                    <div class="md:flex md:space-x-8">
                        <div class="md:w-2/3">
                            <div class="mb-6"> {/* Description Section */}
                                <label for="modal-description" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                    <i class="far fa-file-alt mr-2 text-gray-500"></i>Descripción (Markdown) {/* Changed icon, kept gray-500 as it's descriptive, not interactive like blue-500 ones */}
                                </label>
                                <textarea id="modal-description" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-150 ease-in-out shadow-sm" placeholder="Añadir una descripción más detallada..."></textarea>
                                <div class="mt-2">
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Vista Previa:</label>
                                    <div id="modal-description-preview" class="p-3 border border-gray-200 rounded-lg bg-blue-50 min-h-[80px] prose prose-sm max-w-none text-sm custom-scrollbar overflow-auto"></div>
                                </div>
                            </div>

                            <div id="modal-checklists-container" class="mb-6"> {/* Checklists Section */}
                                <h4 class="text-base font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-tasks mr-2 text-gray-500"></i>Checklist(s) {/* Changed icon */}
                                </h4>
                                <button id="add-checklist-button" class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium hover:underline transition-colors duration-150 ease-in-out"><i class="fas fa-plus-square mr-1.5"></i>Añadir Checklist</button> {/* Added icon margin */}
                            </div>

                            <div class="mt-6"> {/* Activity Section */}
                                <h4 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-history mr-2 text-gray-500"></i>Actividad {/* Changed icon */}
                                </h4>
                                <div class="mb-3"> {/* Comment Input Area */}
                                    <input type="text" id="new-comment-input" placeholder="Escribe un comentario..." class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 ease-in-out shadow-sm">
                                    <button id="submit-comment-button" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all duration-150 ease-in-out shadow-sm hover:shadow-md transform hover:scale-102 active:scale-98"><i class="fas fa-paper-plane mr-2"></i>Comentar</button>
                                </div>
                                <div id="modal-activity-log" class="space-y-3 max-h-60 overflow-y-auto bg-blue-50 p-3 rounded-lg border border-blue-200 text-xs custom-scrollbar">
                                    <p class="text-sm text-gray-500 italic">No hay actividad reciente.</p>
                                </div>
                            </div>
                        </div>

                        <div class="md:w-1/3 mt-6 md:mt-0">
                            <h4 class="text-base font-semibold text-gray-800 mb-3">Añadir a la tarjeta</h4>
                            <div class="mb-4"> {/* Members Button Group */}
                                <button id="manage-members-button" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 px-3 rounded-lg text-sm text-left flex items-center transition-all duration-150 ease-in-out shadow-sm hover:shadow transform hover:scale-102 active:scale-98"><i class="fas fa-users mr-2.5 w-4 text-slate-500"></i>Miembros</button>
                                <div id="modal-members-list" class="mt-1.5 text-sm"></div>
                            </div>
                            <div class="mb-4"> {/* Labels Button Group */}
                                <button id="manage-labels-button" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 px-3 rounded-lg text-sm text-left flex items-center transition-all duration-150 ease-in-out shadow-sm hover:shadow transform hover:scale-102 active:scale-98"><i class="fas fa-tags mr-2.5 w-4 text-slate-500"></i>Etiquetas</button>
                                <div id="modal-labels-list" class="mt-1.5 text-sm"></div>
                            </div>
                            <div class="mb-4"> {/* Due Date Button Group */}
                                 <button id="edit-due-date-button" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 px-3 rounded-lg text-sm text-left flex items-center transition-all duration-150 ease-in-out shadow-sm hover:shadow transform hover:scale-102 active:scale-98"><i class="fas fa-calendar-day mr-2.5 w-4 text-slate-500"></i>Fecha de Vencimiento</button>
                                <div id="modal-due-date-display" class="mt-2 text-sm text-gray-700"></div>
                                <input type="date" id="modal-due-date-input" class="hidden mt-1.5 p-2.5 border border-gray-300 rounded-lg w-full text-sm shadow-sm transition-all duration-150 ease-in-out focus:ring-blue-500">
                            </div>
                            <div class="mb-4"> {/* Location Button Group */}
                                <button id="add-edit-location-button" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 px-3 rounded-lg text-sm text-left flex items-center transition-all duration-150 ease-in-out shadow-sm hover:shadow transform hover:scale-102 active:scale-98"><i class="fas fa-map-marker-alt mr-2.5 w-4 text-slate-500"></i>Ubicación</button>
                                <div id="modal-location-display" class="mt-1.5 text-sm">
                                    <p class="text-gray-500 italic text-xs">No hay ubicación.</p>
                                    <div id="modal-static-map-preview" class="h-28 w-full bg-gray-100 rounded-lg mt-2 border border-gray-200"></div>
                                </div>
                            </div>
                            <div class="mb-4"> {/* Attachments Section */}
                                <h4 class="text-base font-semibold text-gray-800 mb-2 mt-4 flex items-center">
                                    <i class="fas fa-paperclip mr-2 text-gray-500"></i>Archivos Adjuntos {/* Changed icon color */}
                                </h4>
                                <div id="attachments-display-area" class="space-y-1.5 text-sm max-h-36 overflow-y-auto custom-scrollbar p-2.5 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs text-gray-500 italic">No hay archivos adjuntos.</p>
                                </div>
                                <button id="add-attachment-button" class="mt-2 text-xs text-blue-600 hover:text-blue-700 font-medium hover:underline transition-colors duration-150 ease-in-out">
                                    <i class="fas fa-plus-circle mr-1.5"></i>Adjuntar archivo (URL) {/* Added icon margin */}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Pie del Modal -->
                <div class="mt-8 flex justify-end space-x-4 border-t border-gray-200 pt-6">
                    <button id="archive-card-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-5 rounded-lg text-sm transition-all duration-150 ease-in-out shadow-md hover:shadow-lg transform hover:scale-102 active:scale-98"><i class="fas fa-archive mr-2"></i>Archivar</button>
                    <button id="save-card-changes-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg text-sm transition-all duration-150 ease-in-out shadow-md hover:shadow-lg transform hover:scale-102 active:scale-98"><i class="fas fa-save mr-2"></i>Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal para Selector de Ubicación con Leaflet -->
        <div id="location-picker-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-[60] print:hidden transition-opacity duration-300 ease-in-out">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xl w-full transform transition-all duration-300 ease-in-out">
                <div class="flex justify-between items-center mb-5 border-b border-gray-200 pb-3 bg-blue-600 -m-6 p-6 rounded-t-xl"> {/* Modal Header with Blue Background */}
                    <h3 class="text-xl font-semibold text-white"><i class="fas fa-map-marked-alt mr-2"></i>Seleccionar Ubicación</h3> {/* Added icon */}
                    <button id="cancel-location-picker-close-button" class="text-blue-100 hover:text-white hover:bg-blue-500 rounded-full p-1 transition-all duration-150 ease-in-out transform hover:scale-110">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <input type="text" id="location-search-input" placeholder="Buscar dirección..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all duration-150 ease-in-out mt-6"> {/* Added mt-6 for spacing from new header */}
                <div id="leaflet-map-container" style="height: 300px;" class="rounded-lg border border-gray-300 mb-4"></div>
                <p id="selected-location-text" class="mt-3 text-sm text-gray-600">Ubicación seleccionada: Ninguna</p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-location-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2.5 px-4 rounded-lg text-sm transition-all duration-150 ease-in-out shadow-sm hover:shadow transform hover:scale-102 active:scale-98">Cancelar</button>
                    <button id="confirm-location-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition-all duration-150 ease-in-out shadow-md hover:shadow-lg transform hover:scale-102 active:scale-98">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAtdEzxyRKpKZmfk0ZufXcxHI98K5F2GlQ",
        authDomain: "blockbit-board.firebaseapp.com",
        projectId: "blockbit-board",
        storageBucket: "blockbit-board.appspot.com",
        messagingSenderId: "136718217448",
        appId: "1:136718217448:web:5c4d38a4bf506ebac4995d",
        measurementId: "G-3ZH8ER31CY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const boardDocRef = db.collection('boards').doc('blockbit-board');

    let currentBoardData = null;
    let activeCardContext = {}; // Reset properly in closeCardModal
    let leafletMap, leafletMarker, staticPreviewMap; // Map variables

    function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }

    function formatTimestamp(isoString) {
        if (!isoString) return 'Fecha desconocida';
        try {
            const d = new Date(isoString);
            if (isNaN(d.getTime())) return 'Fecha inválida';
            return `${d.toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'})} ${d.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'})}`;
        } catch (e) { console.error("Error formatting timestamp:", e); return 'Error de fecha'; }
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            console.log("Autenticado:", user.uid);
            await initializeAppLogic();
        } else {
            console.log("No autenticado. Intentando anónimo...");
            auth.signInAnonymously().catch(e => console.error("Error sign-in anónimo:", e));
        }
    });

    async function initializeAppLogic() {
        console.log("Inicializando app...");
        try {
            const docSnap = await boardDocRef.get();
            if (!docSnap.exists) {
                console.log("No hay documento. Creando datos iniciales...");
                await setupInitialData();
            } else {
                console.log("Documento encontrado.");
            }
        } catch (e) { console.error("Error verificando documento:", e); }

        boardDocRef.onSnapshot(docSnap => {
            if (docSnap.exists) {
                console.log("Datos recibidos/actualizados.");
                currentBoardData = docSnap.data();
                renderBoard();
            } else {
                console.log("Documento no existe (onSnapshot).");
            }
        }, e => console.error("Error escuchando cambios:", e));
    }

    async function setupInitialData() {
        console.log("Configurando datos iniciales del tablero Tesoros de Artigas...");

        const uid = generateUniqueId; // Alias

        // 1. Define initialTeamMembers and initialAvailableLabels
        const initialTeamMembers = [
            { id: uid(), name: "Tú", avatar: "https://placehold.co/40x40/007bff/ffffff?text=T" },
            { id: uid(), name: "Belén", avatar: "https://placehold.co/40x40/28a745/ffffff?text=B" },
            { id: uid(), name: "Micaela", avatar: "https://placehold.co/40x40/ffc107/000000?text=M" }
        ];

        const initialAvailableLabels = [
            { id: uid(), name: "Tech", color: "bg-indigo-500" },
            { id: uid(), name: "Investigación", color: "bg-purple-500" },
            { id: uid(), name: "Diseño", color: "bg-pink-500" },
            { id: uid(), name: "Gestión", color: "bg-yellow-500" },
            { id: uid(), name: "Estrategia", color: "bg-teal-500" },
            { id: uid(), name: "Comunicación", color: "bg-cyan-500" },
            { id: uid(), name: "Marketing", color: "bg-green-500" },
            { id: uid(), name: "Infraestructura", color: "bg-gray-500" },
            { id: uid(), name: "Producción", color: "bg-orange-500" },
            { id: uid(), name: "Web", color: "bg-sky-500" },
            { id: uid(), name: "Lanzamiento", color: "bg-rose-500" },
            { id: uid(), name: "Logística", color: "bg-lime-500" },
            { id: uid(), name: "Ventas", color: "bg-emerald-500" },
            { id: uid(), name: "Comunidad", color: "bg-fuchsia-500" },
            { id: uid(), name: "Producto", color: "bg-violet-500" }
        ];

        // 2. Create ID mappings
        const idVos = initialTeamMembers.find(m => m.name === "Tú").id;
        const idBelen = initialTeamMembers.find(m => m.name === "Belén").id;
        const idMicaela = initialTeamMembers.find(m => m.name === "Micaela").id;

        const memberPlaceholderToId = {
            "ID_VOS": idVos,
            "ID_BELEN": idBelen,
            "ID_MICAELA": idMicaela
        };

        const labelNameToId = initialAvailableLabels.reduce((acc, label) => {
            acc[label.name.toLowerCase()] = label.id;
            return acc;
        }, {});

        // 3. Embed tesorosDeArtigasRawData (content from tesoros_de_artigas_data.js)
        const tesorosDeArtigasRawData = { // This data is pasted from tesoros_de_artigas_data.js output
            lists: [
                {
                    id: "generateUniqueId()", title: "JUNIO: Planificación y Diseño (Mes 1)", cards: [
                        { id: "generateUniqueId()", title: "Definición del MVP (Semana 1: 16-22 jun)", description: `Tareas (Todo el Equipo): Reunión clave. Definir las 5 "Tarjetas de Tesoro" iniciales (ej: Geoda, Boleadora, Estación AFE, Moneda, Carnaval). Definir la "cuota simbólica" del Programa Fundadores (sugiero $500 UYU por kit).`, dueDate: "2025-06-22T23:59:59Z", members: ["ID_VOS", "ID_BELEN", "ID_MICAELA"], labels: ["gestion", "estrategia"], startDate: "2025-06-16T09:00:00Z", createdAt: "2025-06-16T09:00:00Z", updatedAt: "2025-06-16T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-06-16T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Diseño de Identidad Visual (Semana 2: 23-29 jun)", description: `Tareas (Gurisas): Crear logo y paleta de colores para "Tesoros de Artigas". Diseñar las primeras 5 "Tarjetas de Tesoro" (frente y dorso). Preparar un diseño base para el "Mapa del Tesoro" (A4 plegable).`, dueDate: "2025-06-29T23:59:59Z", members: ["ID_BELEN", "ID_MICAELA"], labels: ["diseño"], startDate: "2025-06-23T09:00:00Z", createdAt: "2025-06-23T09:00:00Z", updatedAt: "2025-06-23T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-06-23T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Plan de Comunicación Inicial (Semana 3: 30 jun - 6 jul)", description: `Tareas (Vos): Redactar borrador del Manifiesto Fundador (1 pág). Definir el mensaje clave y el "tono de voz" de la marca. Crear calendario de contenidos para el primer mes de RRSS.`, dueDate: "2025-07-06T23:59:59Z", members: ["ID_VOS"], labels: ["comunicacion", "marketing"], startDate: "2025-06-30T09:00:00Z", createdAt: "2025-06-30T09:00:00Z", updatedAt: "2025-06-30T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-06-30T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Setup Técnico Inicial (Semana 4: 7-13 jul)", description: `Tareas (Vos): Comprar dominio web (ej: tesorosdeartigas.uy). Crear cuentas de RRSS (Instagram, Facebook, TikTok). Configurar lista de correo en Mailchimp (o similar).`, dueDate: "2025-07-13T23:59:59Z", members: ["ID_VOS"], labels: ["tech", "infraestructura"], startDate: "2025-07-07T09:00:00Z", createdAt: "2025-07-07T09:00:00Z", updatedAt: "2025-07-07T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-07-07T09:00:00Z" }], location: null, coverImage: null, checklists: [] }
                    ]
                },
                {
                    id: "generateUniqueId()", title: "JULIO: Construcción (Mes 2)", cards: [
                        { id: "generateUniqueId()", title: "Producción de Material Gráfico (Semanas 5-6: 14-27 jul)", description: `Tareas (Gurisas): Finalizar diseños de las 5 tarjetas y el mapa. Preparar archivos para imprenta. Buscar presupuestos de imprentas locales.`, dueDate: "2025-07-27T23:59:59Z", members: ["ID_BELEN", "ID_MICAELA"], labels: ["diseño", "produccion"], startDate: "2025-07-14T09:00:00Z", createdAt: "2025-07-14T09:00:00Z", updatedAt: "2025-07-14T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-07-14T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Desarrollo Web - Landing Page (Semanas 7-8: 28 jul - 10 ago)", description: `Tareas (Vos): Construir landing page simple (puede ser con Carrd, Wix, o similar). Incluir: Manifiesto, cómo funciona, formulario de pre-registro para Fundadores.`, dueDate: "2025-08-10T23:59:59Z", members: ["ID_VOS"], labels: ["tech", "web"], startDate: "2025-07-28T09:00:00Z", createdAt: "2025-07-28T09:00:00Z", updatedAt: "2025-07-28T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-07-28T09:00:00Z" }], location: null, coverImage: null, checklists: [] }
                    ]
                },
                {
                    id: "generateUniqueId()", title: "AGOSTO: Lanzamiento (Mes 3)", cards: [
                        { id: "generateUniqueId()", title: "Pre-Lanzamiento RRSS (Semanas 9-10: 11-24 ago)", description: `Tareas (Todo el Equipo): Iniciar publicaciones en RRSS (fotos de Artigas, pistas, Manifiesto). Anunciar Programa Fundadores. Captar primeros pre-registros.`, dueDate: "2025-08-24T23:59:59Z", members: ["ID_VOS", "ID_BELEN", "ID_MICAELA"], labels: ["marketing", "lanzamiento"], startDate: "2025-08-11T09:00:00Z", createdAt: "2025-08-11T09:00:00Z", updatedAt: "2025-08-11T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-08-11T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Producción y Logística Kits (Semanas 11-12: 25 ago - 7 sep)", description: `Tareas (Gurisas): Confirmar imprenta y enviar archivos. Definir packaging básico para los kits de Fundadores. Investigar opciones de envío local/nacional.`, dueDate: "2025-09-07T23:59:59Z", members: ["ID_BELEN", "ID_MICAELA"], labels: ["produccion", "logistica"], startDate: "2025-08-25T09:00:00Z", createdAt: "2025-08-25T09:00:00Z", updatedAt: "2025-08-25T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-08-25T09:00:00Z" }], location: null, coverImage: null, checklists: [] }
                    ]
                },
                {
                    id: "generateUniqueId()", title: "SEPTIEMBRE: Crecimiento (Mes 4)", cards: [
                        { id: "generateUniqueId()", title: "Lanzamiento Oficial Programa Fundadores (Semana 13: 8-14 sep)", description: `Tareas (Todo el Equipo): Abrir inscripciones al Programa Fundadores (link a formulario/MercadoPago). Enviar kits a los primeros Fundadores.`, dueDate: "2025-09-14T23:59:59Z", members: ["ID_VOS", "ID_BELEN", "ID_MICAELA"], labels: ["lanzamiento", "ventas"], startDate: "2025-09-08T09:00:00Z", createdAt: "2025-09-08T09:00:00Z", updatedAt: "2025-09-08T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-09-08T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Contenido y Comunidad (Semanas 14-16: 15 sep - 5 oct)", description: `Tareas (Vos): Mantener flujo de contenido en RRSS. Interactuar con la comunidad. Recopilar feedback de Fundadores.`, dueDate: "2025-10-05T23:59:59Z", members: ["ID_VOS"], labels: ["marketing", "comunidad"], startDate: "2025-09-15T09:00:00Z", createdAt: "2025-09-15T09:00:00Z", updatedAt: "2025-09-15T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-09-15T09:00:00Z" }], location: null, coverImage: null, checklists: [] }
                    ]
                },
                {
                    id: "generateUniqueId()", title: "OCTUBRE: Preparación Final (Mes 5)", cards: [
                        { id: "generateUniqueId()", title: "Diseño Expansión (Semanas 17-18: 6-19 oct)", description: `Tareas (Gurisas): Diseñar las siguientes 5-10 "Tarjetas de Tesoro" basadas en feedback y popularidad.`, dueDate: "2025-10-19T23:59:59Z", members: ["ID_BELEN", "ID_MICAELA"], labels: ["diseño", "producto"], startDate: "2025-10-06T09:00:00Z", createdAt: "2025-10-06T09:00:00Z", updatedAt: "2025-10-06T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-10-06T09:00:00Z" }], location: null, coverImage: null, checklists: [] },
                        { id: "generateUniqueId()", title: "Plan de Lanzamiento Público (Semanas 19-20: 20 oct - 2 nov)", description: `Tareas (Todo el Equipo): Definir estrategia para lanzamiento al público general (post-Fundadores). Planificar eventos o colaboraciones locales.`, dueDate: "2025-11-02T23:59:59Z", members: ["ID_VOS", "ID_BELEN", "ID_MICAELA"], labels: ["estrategia", "lanzamiento"], startDate: "2025-10-20T09:00:00Z", createdAt: "2025-10-20T09:00:00Z", updatedAt: "2025-10-20T09:00:00Z", attachments: [], activity: [{ user: "Sistema", text: "Tarjeta creada.", timestamp: "2025-10-20T09:00:00Z" }], location: null, coverImage: null, checklists: [] }
                    ]
                }
            ]
        };

        // 4. Process raw data
        const processedTesorosLists = tesorosDeArtigasRawData.lists.map(list => ({
            ...list,
            id: uid(), // Generate actual ID for the list
            cards: list.cards.map(card => ({
                ...card,
                id: uid(), // Generate actual ID for the card
                members: card.members.map(memberPlaceholder => memberPlaceholderToId[memberPlaceholder]).filter(id => id),
                labels: card.labels.map(labelName => labelNameToId[labelName.toLowerCase()]).filter(id => id),
                description: card.description || "",
                dueDate: card.dueDate || null,
                startDate: card.startDate || null,
                coverImage: card.coverImage || null,
                checklists: card.checklists || [],
                location: card.location || null,
                attachments: card.attachments || [],
                activity: card.activity || [{ user: "Sistema", text: "Tarjeta creada.", timestamp: card.createdAt || new Date().toISOString() }],
                createdAt: card.createdAt || new Date().toISOString(),
                updatedAt: card.updatedAt || new Date().toISOString(),
            }))
        }));

        // 5. Construct newBoardData
        const newBoardData = {
            title: "Tesoros de Artigas - Plan de Proyecto",
            teamMembers: initialTeamMembers,
            availableLabels: initialAvailableLabels,
            lists: processedTesorosLists,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        try { await boardDocRef.set(newBoardData); console.log("Datos iniciales de Tesoros de Artigas escritos."); }
        catch (e) { console.error("Error escribiendo datos iniciales de Tesoros de Artigas:", e); }
    }

    function renderBoard() {
        if (!currentBoardData || !currentBoardData.lists) return;
        const listsContainer = document.getElementById('lists-container');
        const addListButtonContainer = listsContainer.querySelector('#add-list-button')?.parentElement;
        listsContainer.innerHTML = '';

        currentBoardData.lists.forEach(list => renderList(list, listsContainer));

        if (addListButtonContainer) listsContainer.appendChild(addListButtonContainer);
    }

    function renderList(listData, container) {
        const listEl = document.createElement('div');
        listEl.id = `list-${listData.id}`;
        listEl.className = 'board-list bg-gray-200 p-3 rounded-lg shadow flex flex-col flex-shrink-0 h-full';
        listEl.innerHTML = `
            <h2 class="text-lg font-semibold mb-3 text-gray-700 px-1 flex justify-between items-center">
                <span>${listData.title}</span>
                <span class="text-sm text-gray-500">${listData.cards?.length || 0}</span>
            </h2>
            <div class="cards-container flex-grow space-y-3 overflow-y-auto p-1 min-h-[80px] custom-scrollbar" data-list-id="${listData.id}"></div>
            <button class="add-card-btn mt-3 text-blue-600 hover:text-blue-700 py-2 rounded-md hover:bg-blue-100 w-full text-sm flex items-center justify-center transition-all duration-150 ease-in-out transform hover:scale-102 active:scale-98"> {/* Added full transition */}
                <i class="fas fa-plus mr-2"></i>Añadir tarjeta
            </button>`;
        const cardsCont = listEl.querySelector('.cards-container');
        if (listData.cards?.length) {
            listData.cards.forEach(card => renderCard(card, cardsCont, listData.id));
        } else {
            cardsCont.innerHTML = '<p class="text-xs text-gray-500 p-2 text-center italic">Lista vacía</p>';
        }

        listEl.querySelector('.add-card-btn').addEventListener('click', () => {
            const title = prompt(`Nueva tarjeta para "${listData.title}":`);
            if (title) addNewCardToList(listData.id, title);
        });
        ['dragover', 'dragleave', 'drop'].forEach(evt => cardsCont.addEventListener(evt, window[`handle${evt.charAt(0).toUpperCase() + evt.slice(1)}`]));
        container.appendChild(listEl);
    }

    function renderCard(cardData, container, listId) {
        const cardEl = document.createElement('div');
        cardEl.id = `card-${cardData.id}`;
        // Refined card styling: more padding, subtle border, enhanced shadows
        cardEl.className = 'bg-white p-2.5 rounded-md shadow-md hover:shadow-lg border border-gray-200 flex flex-col space-y-2 transition-all duration-200 ease-in-out hover:-translate-y-px hover:scale-[1.01] transform cursor-pointer';
        cardEl.draggable = true;

        // Card Title
        const titleEl = document.createElement('p');
        titleEl.className = 'font-medium text-sm text-gray-800 break-words';
        titleEl.textContent = cardData.title;

        // Placeholder for metadata icons (future enhancement)
        const metadataPlaceholder = document.createElement('div');
        metadataPlaceholder.className = 'h-5 text-xs text-gray-400 flex items-center space-x-2'; // Fixed height for alignment
        // Example of what could go here if data was rendered:
        // if (cardData.dueDate) metadataPlaceholder.innerHTML += `<i class="fas fa-calendar-alt"></i>`;
        // if (cardData.members?.length) metadataPlaceholder.innerHTML += `<i class="fas fa-users"></i>`;
        // if (cardData.attachments?.length) metadataPlaceholder.innerHTML += `<i class="fas fa-paperclip"></i>`;

        cardEl.appendChild(titleEl);
        cardEl.appendChild(metadataPlaceholder); // Add placeholder even if empty for consistent structure

        cardEl.addEventListener('click', () => openCardModal(cardData, listId));
        cardEl.addEventListener('dragstart', e => handleDragStart(e, cardData.id, listId));
        container.appendChild(cardEl);
    }

    document.getElementById('add-list-button')?.addEventListener('click', async () => {
        const title = prompt("Nombre de la nueva lista:");
        if (title && currentBoardData) {
            const newList = { id: generateUniqueId(), title, cards: [] };
            try { await boardDocRef.update({ lists: [...currentBoardData.lists, newList] }); console.log("Lista añadida."); }
            catch (e) { console.error("Error añadiendo lista:", e); }
        }
    });

    async function addNewCardToList(listId, cardTitle) {
        if (!currentBoardData) return;
        const newCard = {
            id: generateUniqueId(), title: cardTitle, description: "", members: [], labels: [],
            dueDate: null, startDate: null, checklists: [], location: null, attachments: [], activity: [],
            coverImage: null, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
        };
        const newLists = currentBoardData.lists.map(l => l.id === listId ? { ...l, cards: [...(l.cards || []), newCard] } : l);
        try { await boardDocRef.update({ lists: newLists }); console.log("Tarjeta añadida."); }
        catch (e) { console.error("Error añadiendo tarjeta:", e); }
    }

    let draggedItemId = null, originalListId = null;
    function handleDragStart(e, cardId, listId) {
        draggedItemId = cardId; originalListId = listId;
        e.dataTransfer.setData('text/plain', cardId);
        e.target.classList.add('dragging');
    }
    function handleDragOver(e) { e.preventDefault(); e.target.closest('.cards-container')?.classList.add('drag-over-list'); }
    function handleDragLeave(e) { e.target.closest('.cards-container')?.classList.remove('drag-over-list'); }
    async function handleDrop(e) {
        e.preventDefault();
        const targetCont = e.target.closest('.cards-container');
        targetCont?.classList.remove('drag-over-list');
        document.querySelector('.dragging')?.classList.remove('dragging');
        const targetListId = targetCont?.dataset.listId;

        if (!draggedItemId || !originalListId || targetListId === originalListId) {
            draggedItemId = null; originalListId = null; return;
        }
        let cardToMove;
        const tempLists = currentBoardData.lists.map(l => {
            if (l.id === originalListId) {
                cardToMove = l.cards.find(c => c.id === draggedItemId);
                return { ...l, cards: l.cards.filter(c => c.id !== draggedItemId) };
            } return l;
        }).map(l => l.id === targetListId && cardToMove ? { ...l, cards: [...l.cards, cardToMove] } : l );

        if (cardToMove) {
            try { await boardDocRef.update({ lists: tempLists }); console.log("Tarjeta movida."); }
            catch (e) { console.error("Error moviendo tarjeta:", e); renderBoard(); } // Revert on error
        }
        draggedItemId = null; originalListId = null;
    }

    const cardModalEl = document.getElementById('card-detail-modal');
    const modalTitleIn = document.getElementById('modal-title-input');
    const modalDescTA = document.getElementById('modal-description');

    function openCardModal(card, listId) {
        activeCardContext = {
            cardId: card.id, listId,
            ...Object.keys(card).reduce((acc, key) => { // Deep copy relevant fields
                const val = card[key];
                acc[`original${key.charAt(0).toUpperCase() + key.slice(1)}`] = Array.isArray(val) || (typeof val === 'object' && val !== null) ? JSON.parse(JSON.stringify(val)) : val;
                acc[`temp${key.charAt(0).toUpperCase() + key.slice(1)}`] = Array.isArray(val) || (typeof val === 'object' && val !== null) ? JSON.parse(JSON.stringify(val)) : val;
                return acc;
            }, {})
        };
        // Ensure all temp fields exist even if not in cardData
        ['Title', 'Description', 'Members', 'Labels', 'DueDate', 'StartDate', 'Checklists', 'Location', 'Attachments', 'Activity'].forEach(f => {
            if (typeof activeCardContext[`temp${f}`] === 'undefined') activeCardContext[`temp${f}`] = (f === 'Members' || f === 'Labels' || f === 'Checklists' || f === 'Attachments' || f === 'Activity') ? [] : null;
            if (typeof activeCardContext[`original${f}`] === 'undefined') activeCardContext[`original${f}`] = (f === 'Members' || f === 'Labels' || f === 'Checklists' || f === 'Attachments' || f === 'Activity') ? [] : null;
        });


        modalTitleIn.value = activeCardContext.tempTitle || '';
        modalDescTA.value = activeCardContext.tempDescription || '';
        updateDescriptionPreview(activeCardContext.tempDescription || '');
        renderAttachmentsList(activeCardContext.tempAttachments || []);
        renderActivityLog(activeCardContext.tempActivity || []);

        const locDisp = document.getElementById('modal-location-display').querySelector('p');
        const staticMap = document.getElementById('modal-static-map-preview');
        if (activeCardContext.tempLocation?.text) {
            locDisp.textContent = activeCardContext.tempLocation.text;
            updateStaticMapPreview(staticMap, activeCardContext.tempLocation);
        } else {
            locDisp.textContent = "No hay ubicación.";
            if(staticPreviewMap) staticPreviewMap.remove(); staticPreviewMap = null;
            staticMap.innerHTML = '';
        }
        cardModalEl.classList.remove('hidden');
    }

    function closeCardModal() {
        cardModalEl.classList.add('hidden');
        activeCardContext = {}; // Reset
        if (staticPreviewMap) { staticPreviewMap.remove(); staticPreviewMap = null; }
        document.getElementById('modal-static-map-preview').innerHTML = '';
    }

    async function saveCardChanges() {
        if (!activeCardContext.cardId || !currentBoardData) return;
        const updatedCard = {
            id: activeCardContext.cardId,
            title: modalTitleIn.value.trim(),
            description: modalDescTA.value.trim(),
            members: JSON.parse(JSON.stringify(activeCardContext.tempMembers)),
            labels: JSON.parse(JSON.stringify(activeCardContext.tempLabels)),
            dueDate: activeCardContext.tempDueDate,
            startDate: activeCardContext.tempStartDate,
            checklists: JSON.parse(JSON.stringify(activeCardContext.tempChecklists)),
            location: activeCardContext.tempLocation ? JSON.parse(JSON.stringify(activeCardContext.tempLocation)) : null,
            attachments: JSON.parse(JSON.stringify(activeCardContext.tempAttachments)),
            activity: JSON.parse(JSON.stringify(activeCardContext.tempActivity)),
            updatedAt: new Date().toISOString(),
            createdAt: activeCardContext.originalCreatedAt || new Date().toISOString(), // Preserve original
            coverImage: activeCardContext.originalCoverImage || null, // Preserve original
        };
        const newLists = currentBoardData.lists.map(l => l.id === activeCardContext.listId ?
            { ...l, cards: l.cards.map(c => c.id === updatedCard.id ? updatedCard : c) } : l
        );
        try { await boardDocRef.update({ lists: newLists }); console.log("Tarjeta guardada."); closeCardModal(); }
        catch (e) { console.error("Error guardando tarjeta:", e); alert("Error al guardar."); }
    }

    async function archiveCard() {
        if (!activeCardContext.cardId || !confirm("¿Archivar esta tarjeta?")) return;
        const newLists = currentBoardData.lists.map(l => l.id === activeCardContext.listId ?
            { ...l, cards: l.cards.filter(c => c.id !== activeCardContext.cardId) } : l
        );
        try { await boardDocRef.update({ lists: newLists }); console.log("Tarjeta archivada."); closeCardModal(); }
        catch (e) { console.error("Error archivando:", e); }
    }

    function parseMarkdown(md) {
        if (typeof md !== 'string') return '';
        let html = md.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                     .replace(/(?:^|\s)[*_](.*?)[*_](?:$|\s)/g, ' <em>$1</em> '); // Simpler italic for *word* or _word_
        const lines = html.split('\n'); let inList = false;
        html = lines.map(line => {
            const liMatch = line.match(/^\s*-\s+(.*)/);
            if (liMatch) {
                if (!inList) { inList = true; return `<ul><li>${liMatch[1]}</li>`; }
                return `<li>${liMatch[1]}</li>`;
            } else {
                if (inList) { inList = false; return `</ul>${line}`; } return line;
            }
        }).join('\n');
        if (inList) html += '</ul>';
        return html.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>').trim();
    }
    function updateDescriptionPreview(md) { document.getElementById('modal-description-preview').innerHTML = parseMarkdown(md); }
    modalDescTA?.addEventListener('input', e => { updateDescriptionPreview(e.target.value); if (activeCardContext) activeCardContext.tempDescription = e.target.value; });

    function renderAttachmentsList(attachments) {
        const area = document.getElementById('attachments-display-area'); if (!area) return;
        area.innerHTML = (!attachments?.length) ? '<p class="text-xs text-gray-500 italic">No hay archivos adjuntos.</p>' : '';
        if (!attachments?.length) return;
        const ul = document.createElement('ul'); ul.className = 'list-none space-y-1';
        attachments.forEach((att, idx) => {
            const li = document.createElement('li');
            li.className = 'text-xs flex justify-between items-center p-1 bg-gray-100 rounded hover:bg-gray-200';
            li.innerHTML = `<a href="${att.url}" target="_blank" class="text-blue-600 hover:underline break-all" title="${att.url}">${att.name}</a>
                            <button data-idx="${idx}" class="delete-attachment-btn text-red-500 hover:text-red-700 ml-2 p-1 rounded hover:bg-red-100" title="Eliminar"><i class="fas fa-trash-alt"></i></button>`;
            ul.appendChild(li);
        });
        area.appendChild(ul);
        area.querySelectorAll('.delete-attachment-btn').forEach(btn => btn.addEventListener('click', e => {
            activeCardContext.tempAttachments.splice(parseInt(e.currentTarget.dataset.idx), 1);
            renderAttachmentsList(activeCardContext.tempAttachments);
        }));
    }
    document.getElementById('add-attachment-button')?.addEventListener('click', () => {
        const name = prompt("Nombre del archivo:"); if (!name?.trim()) return;
        const url = prompt("URL del archivo (https://...):"); if (!url?.trim()) return;
        if (!url.match(/^https?:\/\//)) { alert("URL inválida."); return; }
        activeCardContext.tempAttachments = activeCardContext.tempAttachments || [];
        activeCardContext.tempAttachments.push({ name: name.trim(), url: url.trim() });
        renderAttachmentsList(activeCardContext.tempAttachments);
    });

    function renderActivityLog(activities) {
        const log = document.getElementById('modal-activity-log'); if (!log) return;
        log.innerHTML = (!activities?.length) ? '<p class="text-xs text-gray-400 italic">No hay actividad reciente.</p>' : '';
        if (!activities?.length) return;
        [...activities].reverse().forEach(act => {
            const entry = document.createElement('div');
            entry.className = 'text-[11px] p-1.5 rounded bg-white shadow-sm border-l-2 border-blue-200';
            entry.innerHTML = `<strong class="text-gray-800">${act.user || "Usuario"}</strong>: <span class="text-gray-600">${act.text || ""}</span>
                               <span class="block text-gray-400 text-[10px] mt-0.5 text-right">${formatTimestamp(act.timestamp)}</span>`;
            log.appendChild(entry);
        });
    }
    const commentBtn = document.getElementById('submit-comment-button'), commentIn = document.getElementById('new-comment-input');
    if (commentBtn && commentIn) {
        const addComment = () => {
            const text = commentIn.value.trim(); if (!text) return;
            activeCardContext.tempActivity = activeCardContext.tempActivity || [];
            activeCardContext.tempActivity.unshift({ user: "Tú", text, timestamp: new Date().toISOString() });
            renderActivityLog(activeCardContext.tempActivity); commentIn.value = '';
        };
        commentBtn.onclick = addComment; commentIn.onkeypress = e => { if (e.key === 'Enter') addComment(); };
    }

    const locPickerModal = document.getElementById('location-picker-modal');
    const locSearchIn = document.getElementById('location-search-input');
    const selLocTxt = document.getElementById('selected-location-text');
    let currentPickedLoc = null;

    function initLeafletMap(lat = -34.397, lng = 150.644) {
        if (leafletMap) leafletMap.remove();
        leafletMap = L.map('leaflet-map-container').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(leafletMap);
        leafletMarker = L.marker([lat, lng], { draggable: true }).addTo(leafletMap)
            .on('dragend', async e => {
                const pos = e.target.getLatLng(); currentPickedLoc = { lat: pos.lat, lng: pos.lng };
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`);
                    const data = await resp.json(); currentPickedLoc.text = data.display_name || `${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}`;
                } catch (err) { currentPickedLoc.text = `${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}`; }
                selLocTxt.textContent = `Seleccionado: ${currentPickedLoc.text}`;
            });
        leafletMap.on('click', e => { leafletMarker.setLatLng(e.latlng).fire('dragend', {target:leafletMarker}); });
    }

    async function searchLocationLeaflet() {
        const q = locSearchIn.value; if (!q) return;
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
            const data = await resp.json();
            if (data?.length) {
                const r = data[0]; currentPickedLoc = { lat: parseFloat(r.lat), lng: parseFloat(r.lon), text: r.display_name };
                leafletMap.setView(currentPickedLoc, 15); leafletMarker.setLatLng(currentPickedLoc);
                selLocTxt.textContent = `Seleccionado: ${r.display_name}`;
            } else { selLocTxt.textContent = "Ubicación no encontrada."; }
        } catch (e) { console.error("Error búsqueda ubicación:", e); }
    }
    locSearchIn?.addEventListener('keypress', e => { if (e.key === 'Enter') searchLocationLeaflet(); });

    function openLocationPicker() {
        currentPickedLoc = activeCardContext.tempLocation ? {...activeCardContext.tempLocation} : null;
        selLocTxt.textContent = currentPickedLoc?.text || "Ninguna ubicación seleccionada.";
        locPickerModal.classList.remove('hidden');
        setTimeout(() => initLeafletMap(currentPickedLoc?.lat, currentPickedLoc?.lng), 100);
        if(currentPickedLoc) leafletMarker?.setLatLng([currentPickedLoc.lat, currentPickedLoc.lng]);
    }

    function confirmLocation() {
        activeCardContext.tempLocation = currentPickedLoc ? {...currentPickedLoc} : null;
        const locDispP = document.getElementById('modal-location-display').querySelector('p');
        const staticMapDiv = document.getElementById('modal-static-map-preview');
        if (activeCardContext.tempLocation?.text) {
            locDispP.textContent = activeCardContext.tempLocation.text;
            updateStaticMapPreview(staticMapDiv, activeCardContext.tempLocation);
        } else {
            locDispP.textContent = "No hay ubicación.";
            if(staticPreviewMap) staticPreviewMap.remove(); staticPreviewMap = null;
            staticMapDiv.innerHTML = '';
        }
        closeLocationPicker();
    }
    function closeLocationPicker() { if (leafletMap) leafletMap.remove(); leafletMap = null; locPickerModal.classList.add('hidden'); }

    function updateStaticMapPreview(container, loc) {
        if (!container || !loc || typeof loc.lat === 'undefined') {
            if(staticPreviewMap) staticPreviewMap.remove(); staticPreviewMap = null; container.innerHTML = ''; return;
        }
        if (staticPreviewMap) staticPreviewMap.remove();
        container.innerHTML = '';
        staticPreviewMap = L.map(container, { dragging: false, zoomControl: false, scrollWheelZoom: false }).setView([loc.lat, loc.lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(staticPreviewMap);
        L.marker([loc.lat, loc.lng]).addTo(staticPreviewMap);
    }

    document.getElementById('add-edit-location-button')?.addEventListener('click', openLocationPicker);
    document.getElementById('confirm-location-button')?.addEventListener('click', confirmLocation);
    document.getElementById('cancel-location-button')?.addEventListener('click', closeLocationPicker);

    const viewBtns = document.querySelectorAll('.view-toggle-btn');
    const views = { 'board-view': document.getElementById('board-view'), 'calendar-view': document.getElementById('calendar-view'),
                    'timeline-view': document.getElementById('timeline-view'), 'dashboard-view': document.getElementById('dashboard-view') };
    viewBtns.forEach(btn => btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        Object.values(views).forEach(v => v?.classList.add('hidden'));
        views[target]?.classList.remove('hidden');
        viewBtns.forEach(b => b.classList.replace('bg-blue-600', 'bg-blue-500')?.classList.remove('active-view-btn'));
        btn.classList.replace('bg-blue-500', 'bg-blue-600'); btn.classList.add('active-view-btn');
    }));

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('close-modal-button')?.addEventListener('click', closeCardModal);
        document.getElementById('save-card-changes-button')?.addEventListener('click', saveCardChanges);
        document.getElementById('archive-card-button')?.addEventListener('click', archiveCard);
        document.getElementById('board-view-btn')?.click(); // Default view
    });
</script>
</body>
</html>
